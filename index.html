<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    <title>ã‚ãã‚ãï¼100ãƒã‚¹è¨ˆç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <!-- è¦‹ãŸç›®ã‚’æ•´ãˆã‚‹ãŸã‚ã®å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã‚„ãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSSã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè¦‹ãŸç›®ã®è¨­å®šï¼‰ã¯ã€å…ƒã®ã¾ã¾ã§å®Œç’§ãªã®ã§å¤‰æ›´ã—ã¦ã„ã¾ã›ã‚“ */
        body {
            font-family: 'M PLUS Rounded 1c', 'Inter', sans-serif;
            background-color: #f0f9ff;
            padding: 1rem;
        }
        .main-container {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            max-width: 2000px;
            margin: 1rem auto;
            padding: 1.5rem;
        }
        .settings-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-end;
            gap: 1rem 1.5rem;
            margin-bottom: 2rem;
        }
        .main-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        @media (min-width: 768px) {
            .main-layout {
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
            }
            .grid-area {
                flex-grow: 1;
                max-width: 70%;
                margin-right: 1.5rem;
            }
            .tenkey-area {
                width: 220px;
                position: sticky;
                top: 1rem;
            }
        }
        .calculation-grid input {
            width: 4rem; height: 2.5rem; text-align: center; border: 1px solid #9ca3af;
            border-radius: 0.375rem; font-size: 1.125rem; font-weight: 700;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            -moz-appearance: textfield; appearance: textfield;
        }
        .calculation-grid input::-webkit-outer-spin-button,
        .calculation-grid input::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .calculation-grid th, .calculation-grid td {
            text-align: center; padding: 0.1rem; min-width: 4rem; height: 2.5rem;
            font-weight: bold; border: 1px solid #e5e7eb;
        }
        .header-cell {
            background-color: #fef9c3; color: #ca8a04; font-size: 1.125rem;
        }
        .top-left-cell {
            background-color: #fde68a; font-size: 1.25rem;
        }
        .highlight-row th, .highlight-row td input, .highlight-row td {
            background-color: #dcfce7 !important;
        }
        .highlight-col th, .highlight-col td input, .highlight-col td {
            background-color: #dcfce7 !important;
        }
        .calculation-grid input:focus {
            outline: 3px solid #2dd4bf; outline-offset: 1px;
            background-color: #f0fdfa; border-color: #14b8a6;
        }
        .incorrect-answer {
            background-color: #fee2e2 !important; color: #ef4444 !important;
            border-color: #ef4444 !important; font-weight: 700;
        }
        .correct-answer {
            background-color: #dbeafe !important; color: #3b82f6;
            border-color: #60a5fa;
        }
        .btn {
            padding: 0.6rem 1.5rem; border-radius: 0.5rem; font-weight: 700;
            transition: all 0.2s ease; cursor: pointer; border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background-color: #fb923c; color: white;
        }
        .btn-primary:hover {
            background-color: #f97316; transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn:disabled {
            background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed;
            transform: none; box-shadow: none;
        }
        #results {
            border: 2px solid #a5f3fc; padding: 1.5rem; border-radius: 0.75rem;
            background-color: #ecfeff; margin-top: 1.5rem;
        }
        #results h2 { color: #0e7490; font-size: 1.5rem; }
        #results p { font-size: 1.125rem; color: #0891b2; }
        #results span.font-bold { color: #0e7490; }
        #message { font-size: 1.125rem; color: #be123c; margin-top: 1rem !important; }
        #recordStatus { font-size: 0.875rem; margin-top: 0.75rem; height: 1.25rem; }
        .status-success { color: #16a34a; }
        .status-error { color: #dc2626; }
        .tenkey {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;
            background-color: #f0fdf4; padding: 1.25rem; border-radius: 0.75rem;
            box-shadow: 0 6px 12px -2px rgb(0 0 0 / 0.1), 0 3px 7px -3px rgb(0 0 0 / 0.1);
            margin-top: 1rem;
        }
        .tenkey button {
            padding: 1rem 0; font-size: 1.25rem; font-weight: 700; border-radius: 0.5rem;
            background-color: #ffffff; color: #34d399; border: 1px solid #a7f3d0;
            cursor: pointer; transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .tenkey button:hover { background-color: #d1fae5; transform: translateY(-1px); }
        .tenkey button:active { background-color: #a7f3d0; transform: translateY(0px); }
        .tenkey .key-del { background-color: #fda4af; color: #be123c; border-color: #fecaca; }
        .tenkey .key-del:hover { background-color: #fb7185; }
        .tenkey .key-del:active { background-color: #fda4af; }
        .tenkey .key-next { background-color: #a5f3fc; color: #0e7490; border-color: #67e8f9; grid-column: span 2; }
        .tenkey .key-next:hover { background-color: #67e8f9; }
        .tenkey .key-next:active { background-color: #a5f3fc; }
        .tenkey .key-0 { grid-column: span 1; }
        .furigana { font-size: 0.75rem; color: #6b7280; margin-left: 0.1em; }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-sky-600 mb-8">ã‚ãã‚ãï¼100ãƒã‚¹è¨ˆç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>

        <!-- ã‚²ãƒ¼ãƒ ã®è¨­å®šã‚¨ãƒªã‚¢ -->
        <div class="settings-area">
            <div>
                <label for="operation" class="block text-lg font-medium text-gray-700 mb-1">è¨ˆç®—<span class="furigana">(ã‘ã„ã•ã‚“)</span>ã®ç¨®é¡<span class="furigana">(ã—ã‚…ã‚‹ã„)</span>:</label>
                <select id="operation" name="operation" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                    <option value="add">ãŸã—ç®— (+)</option>
                    <option value="subtract">å¼•ãç®— (-)</option>
                    <option value="multiply">ã‹ã‘ç®— (Ã—)</option>
                </select>
            </div>
            <div>
                <label for="gridSize" class="block text-lg font-medium text-gray-700 mb-1">ãƒã‚¹<span class="furigana">(ã¾ã™)</span>ã®æ•°<span class="furigana">(ã‹ãš)</span>:</label>
                <select id="gridSize" name="gridSize" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                    <option value="1">10ãƒã‚¹ (1x10)</option>
                    <option value="2">20ãƒã‚¹ (2x10)</option>
                    <option value="3">30ãƒã‚¹ (3x10)</option>
                    <option value="4">40ãƒã‚¹ (4x10)</option>
                    <option value="5">50ãƒã‚¹ (5x10)</option>
                    <option value="6">60ãƒã‚¹ (6x10)</option>
                    <option value="7">70ãƒã‚¹ (7x10)</option>
                    <option value="8">80ãƒã‚¹ (8x10)</option>
                    <option value="9">90ãƒã‚¹ (9x10)</option>
                    <option value="10" selected>100ãƒã‚¹ (10x10)</option>
                </select>
            </div>
            <button id="startButton" class="btn btn-primary text-lg">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        </div>

        <!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="timer" class="text-center text-2xl font-bold text-blue-600 mb-4" style="display: none;">
            ã‚¿ã‚¤ãƒ : <span id="time">0.00</span> ã³ã‚‡ã†
        </div>

        <div class="main-layout">
            <!-- 100ãƒã‚¹è¨ˆç®—ã®è¡¨ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚¨ãƒªã‚¢ -->
            <div id="gridContainer" class="grid-area overflow-x-auto mb-6 md:mb-0"></div>
            <!-- ãƒ†ãƒ³ã‚­ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚¨ãƒªã‚¢ -->
            <div id="tenkeyArea" class="tenkey-area" style="display: none;">
                <div class="tenkey">
                    <button data-key="7">7</button>
                    <button data-key="8">8</button>
                    <button data-key="9">9</button>
                    <button data-key="4">4</button>
                    <button data-key="5">5</button>
                    <button data-key="6">6</button>
                    <button data-key="1">1</button>
                    <button data-key="2">2</button>
                    <button data-key="3">3</button>
                    <button data-key="0" class="key-0">0</button>
                    <button data-key="del" class="key-del">ã‘ã™</button>
                    <button data-key="next" class="key-next">ã¤ãã¸</button>
                </div>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="results" class="text-center" style="display: none;">
            <h2 class="text-xl font-semibold mb-2">ã‘ã£ã‹ ã¯ã£ã´ã‚‡ã†ï¼</h2>
            <p class="mb-1">ã‚¿ã‚¤ãƒ : <span id="finalTime" class="font-bold">0.00</span> ã³ã‚‡ã†</p>
            <p class="mb-1">ç‚¹æ•°<span class="furigana">(ã¦ã‚“ã™ã†)</span>: <span id="score" class="font-bold">0</span> / <span id="totalQuestions">0</span> ã¦ã‚“</p>
            <p id="message" class="mt-2 font-medium"></p>
            <p id="recordStatus" class="text-center"></p>
        </div>
    </div>

    <script>
        // --- ã“ã“ã‹ã‚‰JavaScriptï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚’å‹•ã‹ã™ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼‰ ---

        // HTMLã®å„éƒ¨å“ï¼ˆè¦ç´ ï¼‰ã‚’ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§æ“ä½œã§ãã‚‹ã‚ˆã†ã«å¤‰æ•°ã«å…¥ã‚Œã¦ã„ã¾ã™ã€‚
        const operationSelect = document.getElementById('operation');
        const gridSizeSelect = document.getElementById('gridSize');
        const startButton = document.getElementById('startButton');
        const timerDisplay = document.getElementById('timer');
        const timeSpan = document.getElementById('time');
        const gridContainer = document.getElementById('gridContainer');
        const resultsDiv = document.getElementById('results');
        const finalTimeSpan = document.getElementById('finalTime');
        const scoreSpan = document.getElementById('score');
        const totalQuestionsSpan = document.getElementById('totalQuestions');
        const messagePara = document.getElementById('message');
        const tenkeyArea = document.getElementById('tenkeyArea');
        const recordStatusPara = document.getElementById('recordStatus');

        // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦ãŠããŸã‚ã®å¤‰æ•°ã§ã™ã€‚
        let timerInterval = null; // ã‚¿ã‚¤ãƒãƒ¼ã‚’å‹•ã‹ã—ãŸã‚Šæ­¢ã‚ãŸã‚Šã™ã‚‹ãŸã‚ã®å¤‰æ•°
        let startTime = 0; // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚é–“
        let elapsedTime = 0; // çµŒéæ™‚é–“
        let gameRunning = false; // ã‚²ãƒ¼ãƒ ãŒå®Ÿè¡Œä¸­ã‹ã©ã†ã‹
        let currentGridSize = 10; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒã‚¹ã®ã‚µã‚¤ã‚º
        let currentOperation = 'add'; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹è¨ˆç®—ã®ç¨®é¡
        let totalCells = 0; // å•é¡Œã®ç·æ•°
        let lastFocusedInput = null; // æœ€å¾Œã«é¸æŠã—ãŸå…¥åŠ›ãƒã‚¹
        let currentScore = 0; // ç¾åœ¨ã®ç‚¹æ•°

        // --- ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ãªã©ã®ã€Œãã£ã‹ã‘ã€ã‚’è¨­å®šã—ã¾ã™ ---
        startButton.addEventListener('click', startGame);
        operationSelect.addEventListener('change', () => currentOperation = operationSelect.value);
        gridSizeSelect.addEventListener('change', () => currentGridSize = parseInt(gridSizeSelect.value, 10));
        if (tenkeyArea) {
            tenkeyArea.addEventListener('click', handleTenkeyClick);
        }

        // --- ã“ã“ã‹ã‚‰å„æ©Ÿèƒ½ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆé–¢æ•°ï¼‰ã§ã™ ---

        /**
         * ã€Œã‚¹ã‚¿ãƒ¼ãƒˆï¼ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã«ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
         */
        function startGame() {
            if (gameRunning) return; // ã‚‚ã—ã‚²ãƒ¼ãƒ ãŒæ—¢ã«å§‹ã¾ã£ã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„

            // ã‚²ãƒ¼ãƒ ä¸­ã¯è¨­å®šã‚’å¤‰ãˆã‚‰ã‚Œãªã„ã‚ˆã†ã«ã€ãƒœã‚¿ãƒ³ãªã©ã‚’ç„¡åŠ¹ã«ã—ã¾ã™ã€‚
            operationSelect.disabled = true;
            gridSizeSelect.disabled = true;
            startButton.disabled = true;
            startButton.textContent = 'ãŒã‚“ã°ã‚Œï¼';

            // å‰å›ã®çµæœã‚’éè¡¨ç¤ºã«ã—ã¾ã™ã€‚
            resultsDiv.style.display = 'none';
            recordStatusPara.textContent = '';
            tenkeyArea.style.display = 'block';
            messagePara.textContent = '';

            // æ–°ã—ã„å•é¡Œã®ãƒã‚¹ç›®ã‚’ä½œã‚Šã¾ã™ã€‚
            generateGrid();

            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚
            elapsedTime = 0;
            timeSpan.textContent = formatTime(elapsedTime);
            timerDisplay.style.display = 'block';
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 50); // 0.05ç§’ã”ã¨ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’æ›´æ–°

            gameRunning = true;

            // æœ€åˆã®å…¥åŠ›ãƒã‚¹ã«è‡ªå‹•ã§ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã¾ã™ã€‚
            const firstInput = gridContainer.querySelector('input[type="number"]');
            if (firstInput) {
                firstInput.focus();
            }
        }

        /**
         * è¨ˆç®—ã®ãƒã‚¹ç›®ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
         */
        function generateGrid() {
            gridContainer.innerHTML = ''; // å¤ã„ãƒã‚¹ç›®ã‚’æ¶ˆå»
            const rows = currentGridSize;
            const cols = 10;
            totalCells = rows * cols;
            totalQuestionsSpan.textContent = totalCells;

            const table = document.createElement('table');
            table.className = 'calculation-grid mx-auto border-collapse';
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // è¡¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¸€ç•ªä¸Šã®è¡Œï¼‰ã‚’ä½œæˆ
            const headerRow = document.createElement('tr');
            const topLeftCell = document.createElement('th');
            topLeftCell.className = 'p-1 header-cell top-left-cell';
            switch (currentOperation) {
                case 'add': topLeftCell.textContent = '+'; break;
                case 'subtract': topLeftCell.textContent = '-'; break;
                case 'multiply': topLeftCell.textContent = 'Ã—'; break;
            }
            headerRow.appendChild(topLeftCell);

            const colNumbers = generateRandomNumbers(cols);
            colNumbers.forEach((num, index) => {
                const th = document.createElement('th');
                th.className = 'p-1 header-cell';
                th.textContent = num;
                th.dataset.colIndex = index;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // è¡¨ã®æœ¬ä½“ï¼ˆæ•°å­—ã¨å…¥åŠ›ãƒã‚¹ï¼‰ã‚’ä½œæˆ
            const rowNumbers = generateRandomNumbers(rows);
            for (let i = 0; i < rows; i++) {
                const tr = document.createElement('tr');
                tr.dataset.rowIndex = i;

                const rowHeaderCell = document.createElement('th');
                rowHeaderCell.className = 'p-1 header-cell';
                rowHeaderCell.textContent = rowNumbers[i];
                tr.appendChild(rowHeaderCell);

                for (let j = 0; j < cols; j++) {
                    const td = document.createElement('td');
                    td.className = 'p-0';
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.pattern = "[0-9]*"; // æ•°å­—ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’å„ªå…ˆçš„ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¨­å®š
                    input.dataset.rowIndex = i;
                    input.dataset.colIndex = j;
                    input.dataset.rowHeaderValue = rowNumbers[i];
                    input.dataset.colHeaderValue = colNumbers[j];
                    input.addEventListener('keydown', handleKeyDown);
                    input.addEventListener('focus', handleFocus);
                    input.addEventListener('blur', handleBlur);
                    td.appendChild(input);
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }

            table.appendChild(thead);
            table.appendChild(tbody);
            gridContainer.appendChild(table);
        }

        /**
         * 0ã‹ã‚‰9ã¾ã§ã®æ•°å­—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã€æŒ‡å®šã•ã‚ŒãŸæ•°ã ã‘ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ•°å­—ã‚’è¿”ã™é–¢æ•°
         */
        function generateRandomNumbers(count) {
            const allNumbers = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            // ãƒ•ã‚£ãƒƒã‚·ãƒ£ãƒ¼â€“ã‚¤ã‚§ãƒ¼ãƒ„ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
            for (let i = allNumbers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allNumbers[i], allNumbers[j]] = [allNumbers[j], allNumbers[i]];
            }
            return allNumbers.slice(0, count);
        }

        /**
         * ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
         */
        function updateTimer() {
            if (!gameRunning) return;
            elapsedTime = Date.now() - startTime;
            timeSpan.textContent = formatTime(elapsedTime);
        }

        /**
         * æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ã‚’å°æ•°ç‚¹ä»¥ä¸‹2æ¡ã®ç§’è¡¨ç¤ºã«æ•´å½¢ã™ã‚‹é–¢æ•°
         */
        function formatTime(ms) {
            return (ms / 1000).toFixed(2);
        }

        /**
         * ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆç‰¹ã«Enterã‚­ãƒ¼ï¼‰
         */
        function handleKeyDown(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Enterã‚­ãƒ¼ã§ãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚Œã‚‹ã®ã‚’é˜²ã
                moveToNextCell(event.target);
            }
        }

        /**
         * æ¬¡ã®å…¥åŠ›ãƒã‚¹ã«ç§»å‹•ã™ã‚‹é–¢æ•°
         */
        function moveToNextCell(currentInput) {
            if (!currentInput) return;
            const inputs = Array.from(gridContainer.querySelectorAll('input[type="number"]'));
            const currentIndex = inputs.indexOf(currentInput);
            const nextIndex = currentIndex + 1;

            if (nextIndex < inputs.length) {
                inputs[nextIndex].focus(); // æ¬¡ã®ãƒã‚¹ãŒã‚ã‚Œã°ã€ãã“ã«ç§»å‹•
            } else {
                currentInput.blur(); // æœ€å¾Œã®ãƒã‚¹ãªã‚‰ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ã‚²ãƒ¼ãƒ çµ‚äº†
                finishGame();
            }
        }

        /**
         * å…¥åŠ›ãƒã‚¹ãŒé¸æŠã•ã‚ŒãŸï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸï¼‰æ™‚ã®å‡¦ç†
         */
        function handleFocus(event) {
            lastFocusedInput = event.target;
            if (!gameRunning) return;

            // é¸æŠã•ã‚ŒãŸãƒã‚¹ã®è¡Œã¨åˆ—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã—ã¾ã™ã€‚
            const input = event.target;
            const rowIndex = input.dataset.rowIndex;
            const colIndex = input.dataset.colIndex;

            gridContainer.querySelectorAll('.highlight-row, .highlight-col').forEach(el => {
                el.classList.remove('highlight-row', 'highlight-col');
            });

            const row = input.closest('tr');
            if (row) {
                row.classList.add('highlight-row');
                const rowHeader = row.querySelector('th');
                if(rowHeader) rowHeader.classList.add('highlight-row');
            }
            const table = input.closest('table');
            if(table) {
                const colHeader = table.querySelector(`thead th[data-col-index="${colIndex}"]`);
                if(colHeader) colHeader.classList.add('highlight-col');

                const cellsInCol = table.querySelectorAll(`tbody td input[data-col-index="${colIndex}"]`);
                cellsInCol.forEach(cellInput => cellInput.closest('td').classList.add('highlight-col'));
            }
        }

        /**
         * å…¥åŠ›ãƒã‚¹ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ã®å‡¦ç†
         */
        function handleBlur(event) {
            // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã™ã¹ã¦è§£é™¤ã—ã¾ã™ã€‚
            gridContainer.querySelectorAll('.highlight-row, .highlight-col').forEach(el => {
                el.classList.remove('highlight-row', 'highlight-col');
            });
        }

        /**
         * ãƒ†ãƒ³ã‚­ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
         */
        function handleTenkeyClick(event) {
            if (!gameRunning || !lastFocusedInput || lastFocusedInput.readOnly) return;
            const target = event.target;
            if (!target.matches('button')) return;

            const key = target.dataset.key;

            if (key >= '0' && key <= '9') {
                lastFocusedInput.value += key;
            } else if (key === 'del') {
                lastFocusedInput.value = lastFocusedInput.value.slice(0, -1);
            } else if (key === 'next') {
                moveToNextCell(lastFocusedInput);
            }

            // ã€Œã¤ãã¸ã€ä»¥å¤–ã‚’æŠ¼ã—ãŸã¨ãã¯ã€ã‚«ãƒ¼ã‚½ãƒ«ãŒãƒã‚¹ã‹ã‚‰å¤–ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
            if (key !== 'next') {
                setTimeout(() => {
                    if (lastFocusedInput && !lastFocusedInput.readOnly) {
                        lastFocusedInput.focus();
                    }
                }, 0);
            }
        }

        /**
         * å…¨ã¦ã®ãƒã‚¹ãŒåŸ‹ã¾ã£ãŸæ™‚ã«ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã€çµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         */
        function finishGame() {
            if (!gameRunning) return;
            gameRunning = false;

            clearInterval(timerInterval); // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
            timerDisplay.style.display = 'none';
            tenkeyArea.style.display = 'none';

            calculateScore(); // ç‚¹æ•°ã‚’è¨ˆç®—

            const finalTimeFormatted = formatTime(elapsedTime);
            finalTimeSpan.textContent = finalTimeFormatted;
            resultsDiv.style.display = 'block';

            // çµæœã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã™ã‚‹ã‚ˆã†ä¾é ¼ã—ã¾ã™ã€‚
            sendRecordToSheet(finalTimeFormatted);

            // è¨­å®šãƒœã‚¿ãƒ³ãªã©ã‚’å†ã³æŠ¼ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
            operationSelect.disabled = false;
            gridSizeSelect.disabled = false;
            startButton.disabled = false;
            startButton.textContent = 'ã‚‚ã†ã„ã¡ã©ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼';

            // ç­”ãˆåˆã‚ã›ãŒçµ‚ã‚ã£ãŸã®ã§ã€å…¥åŠ›ãƒã‚¹ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«ã—ã¾ã™ã€‚
            gridContainer.querySelectorAll('input[type="number"]').forEach(input => {
                input.readOnly = true;
                input.blur();
            });
            gridContainer.querySelectorAll('.highlight-row, .highlight-col').forEach(el => {
                el.classList.remove('highlight-row', 'highlight-col');
            });
            lastFocusedInput = null;
        }

        /**
         * ç‚¹æ•°ã‚’è¨ˆç®—ã—ã€é–“é•ã„ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã™ã‚‹é–¢æ•°
         */
        function calculateScore() {
            let correctAnswers = 0;
            const inputs = gridContainer.querySelectorAll('input[type="number"]');

            inputs.forEach(input => {
                input.classList.remove('incorrect-answer', 'correct-answer');
                input.title = '';
                const userAnswer = input.value.trim();
                if (userAnswer === '') {
                    input.classList.add('incorrect-answer');
                    input.title = 'æœªå…¥åŠ›ã§ã™';
                    return;
                }

                const numRowHeader = parseInt(input.dataset.rowHeaderValue, 10);
                const numColHeader = parseInt(input.dataset.colHeaderValue, 10);
                let correctAnswer;

                switch (currentOperation) {
                    case 'add':
                        correctAnswer = numRowHeader + numColHeader;
                        break;
                    case 'subtract':
                        // â˜… è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆ: å°å­¦æ ¡ä½å­¦å¹´ã‚’æƒ³å®šã—ã€ç­”ãˆãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã€å¿…ãšå¤§ãã„æ•°ã‹ã‚‰å°ã•ã„æ•°ã‚’å¼•ãã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
                        correctAnswer = Math.max(numRowHeader, numColHeader) - Math.min(numRowHeader, numColHeader);
                        break;
                    case 'multiply':
                        correctAnswer = numRowHeader * numColHeader;
                        break;
                    default:
                        correctAnswer = NaN;
                }

                // ç­”ãˆåˆã‚ã›
                if (parseInt(userAnswer, 10) === correctAnswer) {
                    correctAnswers++;
                    input.classList.add('correct-answer');
                } else {
                    input.classList.add('incorrect-answer');
                    input.title = `æ­£è§£: ${correctAnswer}`; // ãƒã‚¦ã‚¹ã‚’ä¹—ã›ã‚‹ã¨æ­£è§£ãŒè¡¨ç¤ºã•ã‚Œã‚‹
                }
                input.readOnly = true;
            });

            currentScore = correctAnswers;
            scoreSpan.textContent = currentScore;
            displayMessage(currentScore, totalCells);
        }

        /**
         * ç‚¹æ•°ã«å¿œã˜ãŸåŠ±ã¾ã—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         */
        function displayMessage(score, total) {
            const percentage = total > 0 ? (score / total) * 100 : 0;
            let msg = '';
            if (percentage === 100) {
                msg = 'ğŸ‘‘ ã‹ã‚“ãºãï¼å…¨å•æ­£è§£ã ã‚ˆï¼ã™ã”ã„ã­ï¼ ğŸ‘‘';
            } else if (percentage >= 90) {
                msg = 'âœ¨ ãŠã—ã„ï¼ã‚ã¨ã¡ã‚‡ã£ã¨ï¼é›†ä¸­åŠ›ãŒç´ æ™´ã‚‰ã—ã„ã­ï¼ âœ¨';
            } else if (percentage >= 70) {
                msg = 'ğŸ˜Š ã™ã”ã„ã™ã”ã„ï¼ã‚ˆããŒã‚“ã°ã£ãŸã­ï¼ãã®èª¿å­ã ã‚ˆï¼ ğŸ˜Š';
            } else if (percentage >= 50) {
                msg = 'ğŸ‘ ã†ã‚“ã€ãŒã‚“ã°ã£ã¦ã‚‹ã­ï¼æ¬¡ã¯ã‚‚ã£ã¨ãŸãã•ã‚“æ­£è§£ã§ãã‚‹ã‚ˆï¼ ğŸ‘';
            } else {
                msg = 'ğŸ’ª ãƒ•ã‚¡ã‚¤ãƒˆï¼ã¾ã¡ãŒãˆãŸã¨ã“ã‚ã‚’ ãŠã•ã‚‰ã„ã—ã¦ã€ã¾ãŸæŒ‘æˆ¦ã ï¼ ğŸ’ª';
            }
            const time = parseFloat(finalTimeSpan.textContent);
            if (!isNaN(time)) {
                if (percentage === 100 && time < 90) {
                    msg += '<br>â±ï¸ ã—ã‹ã‚‚ã‚¿ã‚¤ãƒ ãŒã™ã”ãé€Ÿã„ï¼å¤©æ‰ã‹ã‚‚ï¼ï¼Ÿ â±ï¸';
                } else if (time < 150) {
                    msg += '<br>ğŸš€ ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚‚ã„ã„ã­ï¼ ğŸš€';
                }
            }
            messagePara.innerHTML = msg;
        }

        /**
         * çµæœã‚’Google Apps Scriptï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰ã«é€ä¿¡ã™ã‚‹é–¢æ•°
         * @param {string} finalTimeFormatted ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ã®æœ€çµ‚ã‚¿ã‚¤ãƒ 
         */
        function sendRecordToSheet(finalTimeFormatted) {
            const questions = totalCells;
            const score = currentScore;
            const time = finalTimeFormatted;
            const operationMap = { add: 'ãŸã—ç®—', subtract: 'å¼•ãç®—', multiply: 'ã‹ã‘ç®—' };
            const operationName = operationMap[currentOperation] || currentOperation;

            // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã¾ã™ã€‚
            const dataToSend = {
                operation: operationName,
                questions: questions,
                score: score,
                time: time
            };

            recordStatusPara.textContent = 'è¨˜éŒ²ã‚’é€ä¿¡ä¸­...';
            recordStatusPara.className = 'text-center';

            // google.script.run ã‚’ä½¿ã£ã¦ã€ã‚µãƒ¼ãƒãƒ¼å´ã® 'recordResult' é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
            google.script.run
                .withSuccessHandler(onRecordSuccess) // æˆåŠŸã—ãŸã‚‰ onRecordSuccess é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                .withFailureHandler(onRecordFailure) // å¤±æ•—ã—ãŸã‚‰ onRecordFailure é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                .recordResult(dataToSend);
        }

        /**
         * è¨˜éŒ²ã®é€ä¿¡ãŒæˆåŠŸã—ãŸæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
         * @param {string} response - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®æˆ»ã‚Šå€¤ ("Success"ãªã©)
         */
        function onRecordSuccess(response) {
            console.log('Record Success:', response);
            if (response === "Success") {
                recordStatusPara.textContent = 'ğŸ‘ è¨˜éŒ²ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼';
                recordStatusPara.className = 'text-center status-success';
            } else {
                recordStatusPara.textContent = `â“ è¨˜éŒ²ã®é€ä¿¡ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${response}`;
                recordStatusPara.className = 'text-center status-error';
            }
        }

        /**
         * è¨˜éŒ²ã®é€ä¿¡ãŒå¤±æ•—ã—ãŸæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
         * @param {Error} error - ã‚¨ãƒ©ãƒ¼æƒ…å ±
         */
        function onRecordFailure(error) {
            console.error('Record Failure:', error);
            recordStatusPara.textContent = `âŒ è¨˜éŒ²ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
            recordStatusPara.className = 'text-center status-error';
        }

    </script>
</body>
</html>
