<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>100マス計算</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.20/dist/sweetalert2.min.css">
  
  <!-- TensorFlow.js (安定版に変更) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>

  <!-- css.html の読み込み -->
  <?!= include('css'); ?>
</head>
<body>
  
  <!-- 通信中のローディングオーバーレイ -->
  <div id="loading-overlay">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-3 fw-bold text-primary"><ruby>通信中<rt>つうしんちゅう</rt></ruby>...</div>
  </div>

  <div class="container py-4 mx-auto" style="max-width: 800px;">
    
    <!-- アプリタイトル -->
    <header class="text-center mb-4">
      <h1 class="text-primary fw-bold">
        <i class="bi bi-calculator"></i> 100マス<ruby>計算<rt>けいさん</rt></ruby>
      </h1>
    </header>

    <!-- メインコンテンツ領域（カード） -->
    <main class="card rounded-3 shadow-sm border-0">
      <div class="card-body p-4">

        <!-- ==========================================
             メイン画面 (設定とプレイを統合)
        =========================================== -->
        <div id="page-main" class="page active">
          
          <!-- 上部コントロールパネル -->
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 bg-light p-3 rounded-3">
            <div class="d-flex gap-3 align-items-center mb-2 mb-md-0">
              <div>
                <label class="form-label fw-bold small text-muted mb-1"><ruby>計算<rt>けいさん</rt></ruby></label>
                <select id="mode-select" class="form-select form-select-sm" style="width: 120px;" onchange="previewTable()">
                  <option value="たし算">たし<ruby>算<rt>ざん</rt></ruby></option>
                  <option value="引き算">ひき<ruby>算<rt>ざん</rt></ruby></option>
                  <option value="かけ算">かけ<ruby>算<rt>ざん</rt></ruby></option>
                </select>
              </div>
              <div>
                <label class="form-label fw-bold small text-muted mb-1"><ruby>問題数<rt>もんだいすう</rt></ruby></label>
                <select id="count-select" class="form-select form-select-sm" style="width: 100px;" onchange="previewTable()">
                  <option value="10">10<ruby>問<rt>もん</rt></ruby></option>
                  <option value="20">20<ruby>問<rt>もん</rt></ruby></option>
                  <option value="30">30<ruby>問<rt>もん</rt></ruby></option>
                  <option value="40">40<ruby>問<rt>もん</rt></ruby></option>
                  <option value="50">50<ruby>問<rt>もん</rt></ruby></option>
                  <option value="60">60<ruby>問<rt>もん</rt></ruby></option>
                  <option value="70">70<ruby>問<rt>もん</rt></ruby></option>
                  <option value="80">80<ruby>問<rt>もん</rt></ruby></option>
                  <option value="90">90<ruby>問<rt>もん</rt></ruby></option>
                  <option value="100">100<ruby>問<rt>もん</rt></ruby></option>
                </select>
              </div>
            </div>
            
            <div class="d-flex gap-3 align-items-center">
              <div class="fs-4 fw-bold text-danger">
                <i class="bi bi-stopwatch"></i> <span id="timer-display">0.0</span> <ruby>秒<rt>びょう</rt></ruby>
              </div>
              <button id="start-btn" class="btn btn-giga px-4" onclick="startGame()">
                <i class="bi bi-play-circle-fill"></i> スタート！
              </button>
            </div>
          </div>

          <!-- 計算表とキャンバスのレイアウト -->
          <div class="row">
            <!-- 左側：計算表 -->
            <div class="col-lg-8 mb-4">
              <div id="calc-table-container" class="calc-table-container"></div>
            </div>
            
            <!-- 右側：手書きキャンバス -->
            <div class="col-lg-4 mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label fw-bold text-muted mb-0"><ruby>手書<rt>てが</rt></ruby>き入力</label>
                <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="clearAllCanvas(true)">
                  <i class="bi bi-eraser"></i> <ruby>消<rt>け</rt></ruby>す
                </button>
              </div>
              
              <!-- 2つのキャンバスを並べる -->
              <div class="d-flex justify-content-center gap-2">
                <div class="drawing-canvas-container" style="flex: 1; height: 160px;">
                  <canvas id="handwriting-canvas-1" style="width: 100%; height: 100%; display: block;"></canvas>
                </div>
                <div class="drawing-canvas-container" style="flex: 1; height: 160px;">
                  <canvas id="handwriting-canvas-2" style="width: 100%; height: 100%; display: block;"></canvas>
                </div>
              </div>
              <div class="d-flex justify-content-around mt-1">
                 <small class="text-muted fw-bold">十の位</small>
                 <small class="text-muted fw-bold">一の位</small>
              </div>
              
              <div id="ocr-status" class="small text-muted text-center mt-2 fw-bold"></div>
            </div>
          </div>

        </div>

        <!-- ==========================================
             ページ3: 結果画面
        =========================================== -->
        <div id="page-result" class="page text-center">
          <h2 class="mb-4 h3 text-success fw-bold"><i class="bi bi-stars"></i> <ruby>結果<rt>けっか</rt></ruby>はっぴょう！</h2>
          
          <div class="bg-light rounded-3 p-4 mb-4 mx-auto" style="max-width: 400px;">
            <div class="row g-3">
              <div class="col-6">
                <div class="text-muted small"><ruby>正解<rt>せいかい</rt></ruby></div>
                <div class="fs-2 fw-bold text-primary" id="result-score">-- / --</div>
              </div>
              <div class="col-6 border-start">
                <div class="text-muted small">タイム</div>
                <div class="fs-2 fw-bold text-danger"><span id="result-time">--</span></div>
              </div>
            </div>
          </div>

          <button class="btn btn-giga btn-lg w-100 mb-3" style="max-width: 300px;" onclick="resetGame()">
            <i class="bi bi-arrow-clockwise"></i> もういちど！
          </button>
        </div>

      </div>
    </main>
    
    <!-- 固定フッター (ガイドライン完全一致) -->
    <footer class="text-center text-muted py-3 mt-4 border-top">
      <small>© 2026 100マス<ruby>計算<rt>けいさん</rt></ruby> <a href="https://note.com/cute_borage86" target="_blank" class="text-decoration-none text-muted">GIGA山</a></small>
    </footer>

  </div>

  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.20/dist/sweetalert2.all.min.js"></script>
  <!-- js.html の読み込み -->
  <?!= include('js'); ?>
</body>
</html>
